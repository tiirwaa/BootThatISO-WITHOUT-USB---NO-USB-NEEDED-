name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake ..

      - name: Check formatting
        run: |
          cd build
          cmake --build . --target check-format --config Release

      - name: Build project
        run: |
          cd build
          cmake --build . --config Release

      - name: Run unit tests
        run: |
          cd build
          cmake --build . --config Release --target UtilsTests
          ctest -C Release --output-on-failure

      - name: Create code signing certificate
        run: |
          New-SelfSignedCertificate -Type CodeSigningCert -Subject "CN=BootThatISO Dev" -KeyUsage DigitalSignature -KeyLength 2048 -CertStoreLocation "Cert:\CurrentUser\My" -NotAfter (Get-Date).AddYears(1)
        shell: powershell

      - name: Find signtool path
        run: |
          $signtool = Get-Command signtool -ErrorAction SilentlyContinue
          if ($signtool) {
            $signtoolPath = $signtool.Source
          } else {
            $sdkPaths = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Directory -Recurse | Where-Object { Test-Path (Join-Path $_.FullName "x64\signtool.exe") } | Sort-Object Name -Descending | Select-Object -First 1
            if ($sdkPaths) {
              $signtoolPath = Join-Path $sdkPaths.FullName "x64\signtool.exe"
            } else {
              throw "signtool not found"
            }
          }
          echo "SIGNTOOL_PATH=$signtoolPath" >> $env:GITHUB_ENV
          Write-Host "Signtool path: $signtoolPath"
        shell: pwsh

      - name: Sign the executable
        run: |
          & $env:SIGNTOOL_PATH sign /fd SHA256 /a /d "BootThatISO - Bootear ISO sin USB" /du "https://github.com/tiirwaa/BootThatISO-WITHOUT-USB---NO-USB-NEEDED-" /tr http://timestamp.digicert.com /td SHA256 "./build/Release/BootThatISO!.exe"
        shell: pwsh

      - name: Create release notes
        shell: pwsh
        run: |
          $lines = @(
            "## Requisitos del Sistema",
            "",
            "- Windows 10 u 11 de 64 bits con privilegios de administrador.",
            "- PowerShell, DiskPart, bcdedit y herramientas de l$([char]0x00ED)nea de comandos de Windows disponibles en el sistema.",
            "- Espacio libre m$([char]0x00ED)nimo de 12 GB en la unidad C: para crear y formatear particiones.",
            "",
            "## Descarga",
            "Descarga el ejecutable desde los assets adjuntos."
          )
          $lines | Out-File -FilePath release_notes.md -Encoding utf8

      - name: Create Release
        run: gh release create ${{ github.ref_name }} --generate-notes --notes-file release_notes.md ./build/Release/BootThatISO!.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
