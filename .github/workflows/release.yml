name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake ..

      - name: Check formatting
        run: |
          cd build
          cmake --build . --target check-format --config Release

      - name: Build project
        run: |
          cd build
          cmake --build . --config Release

      - name: Run unit tests
        run: |
          cd build
          cmake --build . --config Release --target UtilsTests
          ctest -C Release --output-on-failure

      - name: Create release notes
        shell: pwsh
        run: |
          $lines = @(
            "## Requisitos del Sistema",
            "",
            "- Windows 10 u 11 de 64 bits con privilegios de administrador.",
            "- PowerShell, DiskPart, bcdedit y herramientas de l$([char]0x00ED)nea de comandos de Windows disponibles en el sistema.",
            "- Espacio libre m$([char]0x00ED)nimo de 12 GB en la unidad C: para crear y formatear particiones.",
            "",
            "## Descarga",
            "Descarga el ejecutable desde los assets adjuntos."
          )
          $lines | Out-File -FilePath release_notes.md -Encoding utf8

      - name: Create Release
        run: gh release create ${{ github.ref_name }} --generate-notes --notes-file release_notes.md ./build/Release/BootThatISO!.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
